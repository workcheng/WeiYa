var getAllUserInfo=[],setintIndex=0,luckCount=0,userCount=1,getRandom=function(e,t){var s=Math.random()*(t-e),n=Math.round(s+e);return n=Math.max(Math.min(n,t),e)},getLottery=function(){var e=BaseUrl+"user/userList";$.ajax({async:!0,url:e,success:function(e){getAllUserInfo=e.data}})},getCnt=function(){console.log("获取总数");var e=BaseUrl+"user/userListCount";$.ajax({async:!0,url:e,success:function(e){"1000"==e.status?$("#userCount").text(e.data):showInfo("活动尚未开始！",0)}})},getLuckyUser=function(e){var t=$("select[name='userNum']").val(),s=BaseUrl+"user/lotteryUserList?time="+getRandom(1,1e3);$.ajax({url:s,data:{count:t},success:function(t){"function"==typeof e&&e(t)}})},isAuto=function(){if(setintIndex=setInterval(function(){var e=getRandom(0,getAllUserInfo.length-1);$("#userName").html(getAllUserInfo[e].name),$("#userImg").attr("src",getAllUserInfo[e].headImgUrl)},100),getAllUserInfo.length>0){$("select[name='userNum']").val();beginLuck()}else showInfo("当前还没有人参加活动！",0);return $(".condition").addClass("disabled"),!1},beginLuck=function(){$("#beginLuck").hide(),$("#stopLuck").show()},stopLuck=function(){$("#beginLuck").show(),$("#stopLuck").hide();var e=$("select[name='prize']").val(),t=($("select[name='userNum']").val(),BaseUrl+"user/lotterySelect?time="+getRandom(1,1e3));return $.ajax({url:t,success:function(t){if(t.data.length>0){var s=t.data[0],n=s.openId;$("#userName").html(s.name),$("#userImg").attr("src",s.headImgUrl);var a=s.name,u=s.headImgUrl;showLuckAnimate(u,e,a),clearInterval(setintIndex),showLuckyUser(userCount,u,a,e),sengMsg(n,a,e),userCount+=1}else showLuckAnimate("images/default.png","","小伙伴们都已经中奖啦！",!0)}}),!1},showLuckyUser=function(e,t,s,n){var a=$("<li></li>").addClass("list-content clearfix"),u=$("<div></div>").addClass("list-idx").text(e),i=$("<div></div>").addClass("list-user"),o=$("<img>").attr("src",t),c=$("<p></p>").addClass("text-overflow").text(s),r=$("<div></div>").addClass("list-prize text-overflow"),l=$("<div></div>").addClass("list-prize-name text-overflow").text(n);i.append(o).append(c),a.append(u).append(i).append(r).append(l),$("#luckyUser").find("ul").prepend(a)},showLuckAnimate=function(e,t,s){$("body").append('<div class="animate-bg"><div class="light"></div><img class="luckbg" src="images/luckbg.png" /><img src="'+e+'" class="luckUserHead" /><div class="showLuckUserName">'+s+'</div><div class="showLuckLevel">恭喜<span>'+s+"</span> 获<span>"+t+"</span>！</div></div>"),$(".luckbg").animate({width:"800px",height:"518px","margin-top":"-330px","margin-left":"-400px",opacity:"1"},"fast"),$(".luckUserHead").animate({"margin-top":"-275px"}),$(".showLuckLevel").animate({"margin-top":"40px"}),$(".showLuckUserName").animate({opacity:"1"}),setTimeout(function(){$(".animate-bg").animate({opacity:"0"},"slow",function(){$(".animate-bg").remove()}),$("#bgsound").remove();var e=$("select[name='userNum']").val();if(1!=e){isAuto();var t=setTimeout(function(){stopLuck(),luckCount+=1},2e3);luckCount==e&&(clearTimeout(t),clearInterval(setintIndex),luckCount=0,$("#beginLuck").show(),$("#stopLuck").hide())}},3e3)},sengMsg=function(e,t,s){var n="";switch(s){case"一等奖":n="0";break;case"二等奖":n="1";break;case"三等奖":n="2"}var a=[];a.push({openId:e,name:t,degree:n}),a=JSON.stringify(a);var u=BaseUrl+"message/sendMsg";$.ajax({type:"POST",contentType:"application/json",url:u,data:a,success:function(e){console.log("send",JSON.stringify(e))}})};$(document).ready(function(){getLottery(),$("#beginLuck").click(function(){var e=$("select[name='userNum']").val(),t=BaseUrl+"user/unHitUserSize";$.ajax({url:t,success:function(t){t.data>=e?(e>1&&setTimeout(function(){stopLuck(),luckCount=1},2e3),isAuto()):showInfo("抽奖人数不够！",0)}})}),$("#stopLuck").click(function(){stopLuck()}),$(window).load(function(){$("#background").fullBg()}),setInterval(function(){getCnt()},5e3)});